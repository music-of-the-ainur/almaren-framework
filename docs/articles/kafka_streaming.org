** How to Stream Data From Kafka Using Almaren Framework

*** Introduction

Near real-time data processing has become essential to any enterprise organization. With [[https://github.com/music-of-the-ainur/almaren-framework][Almaren Framework]]
is easy to create streaming with minimalist transformation, you still have /Spark-SQL/ and other powerful 
components like [[https://github.com/music-of-the-ainur/quenya-dsl][Quenya-DSL]] with allows you to easily parse semi-structured documents like XML, JSON, Avro etc.

*** About

The [[https://github.com/music-of-the-ainur/almaren-framework][Almaren Framework]] provides a simplified consistent minimalistic layer over Apache Spark. While still allowing you to take advantage of native Apache Spark features.
You can still combine it with standard Spark code.

*** Use Case 

- Read Twitter JSON From Kafka
- Parser specific elements
  1. user.id
  2. user.name
  3. user.time_zone
  4. user.friends_count
  5. user.followers_count
  6. source
  7. place.country
  8. timestamp_ms
  9. text
  10. entities.hashtags.text
- Remove Duplicates
- Add Unique Key
- Add Current Timestamp
- Store data to PostgreSQL
- Index data to Solr


Follow sample data from Twitter, each JSON has over 1000 attributes:

#+begin_src json :eval no
{"created_at":"Thu Feb 13 02:29:26 +0000 2020","id":1227781800069488640,"id_str":"1227781800069488640","text":"RT @HOOAH69: Swalwell: Impeaching Trump Over Roger Stone Is Not \u2018Off the Table...then he says, \"We want to work with him on prescription dr\u2026","source":"\u003ca href=\"https:\/\/mobile.twitter.com\" rel=\"nofollow\"\u003eTwitter Web App\u003c\/a\u003e","truncated":false,"in_reply_to_status_id":null,"in_reply_to_status_id_str":null,"in_reply_to_user_id":null,"in_reply_to_user_id_str":null,"in_reply_to_screen_name":null,"user":{"id":1029861942133809153,"id_str":"1029861942133809153","name":"NoirCowboy","screen_name":"cowboy_noir","location":"Arizona, USA","url":null,"description":"I like to put my bullshit filter on. Stop & troll thats how I roll. If I make you think do not get mad at me. I want the whole truth and nothing but the truth!","translator_type":"none","protected":false,"verified":false,"followers_count":1307,"friends_count":1032,"listed_count":1,"favourites_count":37878,"statuses_count":39465,"created_at":"Wed Aug 15 22:46:35 +0000 2018","utc_offset":null,"time_zone":null,"geo_enabled":false,"lang":null,"contributors_enabled":false,"is_translator":false,"profile_background_color":"F5F8FA","profile_background_image_url":"","profile_background_image_url_https":"","profile_background_tile":false,"profile_link_color":"1DA1F2","profile_sidebar_border_color":"C0DEED","profile_sidebar_fill_color":"DDEEF6","profile_text_color":"333333","profile_use_background_image":true,"profile_image_url":"http:\/\/pbs.twimg.com\/profile_images\/1188908867943571457\/e_4RjWTU_normal.jpg","profile_image_url_https":"https:\/\/pbs.twimg.com\/profile_images\/1188908867943571457\/e_4RjWTU_normal.jpg","profile_banner_url":"https:\/\/pbs.twimg.com\/profile_banners\/1029861942133809153\/1566723854","default_profile":true,"default_profile_image":false,"following":null,"follow_request_sent":null,"notifications":null},"geo":null,"coordinates":null,"place":null,"contributors":null,"retweeted_status":{"created_at":"Thu Feb 13 02:04:18 +0000 2020","id":1227775473289052160,"id_str":"1227775473289052160","text":"Swalwell: Impeaching Trump Over Roger Stone Is Not \u2018Off the Table...then he says, \"We want to work with him on pres\u2026 https:\/\/t.co\/CI4bPP3W3q","source":"\u003ca href=\"http:\/\/twitter.com\" rel=\"nofollow\"\u003eTwitter Web Client\u003c\/a\u003e","truncated":true,"in_reply_to_status_id":null,"in_reply_to_status_id_str":null,"in_reply_to_user_id":null,"in_reply_to_user_id_str":null,"in_reply_to_screen_name":null,"user":{"id":4871068484,"id_str":"4871068484","name":"Robert Hardin","screen_name":"HOOAH69","location":"Maui, Hi","url":null,"description":"Retired-Veteran..supporting traditional American values, dictates of our founding fathers & Wisdom of our Constitution. IF & IFB. #MAGA #KAG #TrumpLandslide2020","translator_type":"none","protected":false,"verified":false,"followers_count":19174,"friends_count":19994,"listed_count":11,"favourites_count":18968,"statuses_count":14700,"created_at":"Sun Feb 07 00:38:35 +0000 2016","utc_offset":null,"time_zone":null,"geo_enabled":false,"lang":null,"contributors_enabled":false,"is_translator":false,"profile_background_color":"000000","profile_background_image_url":"http:\/\/abs.twimg.com\/images\/themes\/theme1\/bg.png","profile_background_image_url_https":"https:\/\/abs.twimg.com\/images\/themes\/theme1\/bg.png","profile_background_tile":false,"profile_link_color":"1B95E0","profile_sidebar_border_color":"000000","profile_sidebar_fill_color":"000000","profile_text_color":"000000","profile_use_background_image":false,"profile_image_url":"http:\/\/pbs.twimg.com\/profile_images\/1165449145626157057\/oky8k0PJ_normal.jpg","profile_image_url_https":"https:\/\/pbs.twimg.com\/profile_images\/1165449145626157057\/oky8k0PJ_normal.jpg","profile_banner_url":"https:\/\/pbs.twimg.com\/profile_banners\/4871068484\/1454806639","default_profile":false,"default_profile_image":false,"following":null,"follow_request_sent":null,"notifications":null},"geo":null,"coordinates":null,"place":null,"contributors":null,"is_quote_status":false,"extended_tweet":{"full_text":"Swalwell: Impeaching Trump Over Roger Stone Is Not \u2018Off the Table...then he says, \"We want to work with him on prescription drugs, background checks, and infrastructure\". Sounds like Swalwell throwing out a threat for a quid pro quo. Dummy!  https:\/\/t.co\/rO2ozLtOzo","display_text_range":[0,265],"entities":{"hashtags":[],"urls":[{"url":"https:\/\/t.co\/rO2ozLtOzo","expanded_url":"http:\/\/bit.ly\/31WpCUc","display_url":"bit.ly\/31WpCUc","indices":[242,265]}],"user_mentions":[],"symbols":[]}},"quote_count":4,"reply_count":13,"retweet_count":41,"favorite_count":57,"entities":{"hashtags":[],"urls":[{"url":"https:\/\/t.co\/CI4bPP3W3q","expanded_url":"https:\/\/twitter.com\/i\/web\/status\/1227775473289052160","display_url":"twitter.com\/i\/web\/status\/1\u2026","indices":[117,140]}],"user_mentions":[],"symbols":[]},"favorited":false,"retweeted":false,"possibly_sensitive":false,"filter_level":"low","lang":"en"},"is_quote_status":false,"quote_count":0,"reply_count":0,"retweet_count":0,"favorite_count":0,"entities":{"hashtags":[],"urls":[],"user_mentions":[{"screen_name":"HOOAH69","name":"Robert Hardin","id":4871068484,"id_str":"4871068484","indices":[3,11]}],"symbols":[]},"favorited":false,"retweeted":false,"filter_level":"low","lang":"en","timestamp_ms":"1581560966876"}
{"created_at":"Thu Feb 13 02:29:27 +0000 2020","id":1227781801768374273,"id_str":"1227781801768374273","text":"eu n\u00e3o gosto do formato da cabe\u00e7a humana","source":"\u003ca href=\"http:\/\/twitter.com\/download\/android\" rel=\"nofollow\"\u003eTwitter for Android\u003c\/a\u003e","truncated":false,"in_reply_to_status_id":null,"in_reply_to_status_id_str":null,"in_reply_to_user_id":null,"in_reply_to_user_id_str":null,"in_reply_to_screen_name":null,"user":{"id":3853833503,"id_str":"3853833503","name":"deus frango \u00e9 assado fiel 9,99","screen_name":"viuvadolula","location":"inferno","url":null,"description":"\u00f3dio tristeza e solid\u00e3o","translator_type":"none","protected":false,"verified":false,"followers_count":484,"friends_count":1717,"listed_count":0,"favourites_count":78562,"statuses_count":10364,"created_at":"Sat Oct 03 16:28:34 +0000 2015","utc_offset":null,"time_zone":null,"geo_enabled":true,"lang":null,"contributors_enabled":false,"is_translator":false,"profile_background_color":"C0DEED","profile_background_image_url":"http:\/\/abs.twimg.com\/images\/themes\/theme1\/bg.png","profile_background_image_url_https":"https:\/\/abs.twimg.com\/images\/themes\/theme1\/bg.png","profile_background_tile":false,"profile_link_color":"1DA1F2","profile_sidebar_border_color":"C0DEED","profile_sidebar_fill_color":"DDEEF6","profile_text_color":"333333","profile_use_background_image":true,"profile_image_url":"http:\/\/pbs.twimg.com\/profile_images\/1129353808130318338\/MEeNStG-_normal.jpg","profile_image_url_https":"https:\/\/pbs.twimg.com\/profile_images\/1129353808130318338\/MEeNStG-_normal.jpg","profile_banner_url":"https:\/\/pbs.twimg.com\/profile_banners\/3853833503\/1501986335","default_profile":true,"default_profile_image":false,"following":null,"follow_request_sent":null,"notifications":null},"geo":null,"coordinates":null,"place":null,"contributors":null,"is_quote_status":false,"quote_count":0,"reply_count":0,"retweet_count":0,"favorite_count":0,"entities":{"hashtags":[],"urls":[],"user_mentions":[],"symbols":[]},"favorited":false,"retweeted":false,"filter_level":"low","lang":"pt","timestamp_ms":"1581560967281"}
{"created_at":"Thu Feb 13 02:29:27 +0000 2020","id":1227781803118923782,"id_str":"1227781803118923782","text":"RT @CGurisattiNTN24: Cada vez que abrimos un micr\u00f3fono para escuchar a una persona nos exponemos a cualquier reacci\u00f3n humana del entrevista\u2026","source":"\u003ca href=\"http:\/\/twitter.com\/download\/android\" rel=\"nofollow\"\u003eTwitter for Android\u003c\/a\u003e","truncated":false,"in_reply_to_status_id":null,"in_reply_to_status_id_str":null,"in_reply_to_user_id":null,"in_reply_to_user_id_str":null,"in_reply_to_screen_name":null,"user":{"id":416466777,"id_str":"416466777","name":"Jimer Lozano Portela","screen_name":"JimerLozanoPort","location":null,"url":null,"description":null,"translator_type":"none","protected":false,"verified":false,"followers_count":246,"friends_count":877,"listed_count":0,"favourites_count":11774,"statuses_count":9822,"created_at":"Sat Nov 19 18:41:40 +0000 2011","utc_offset":null,"time_zone":null,"geo_enabled":false,"lang":null,"contributors_enabled":false,"is_translator":false,"profile_background_color":"C0DEED","profile_background_image_url":"http:\/\/abs.twimg.com\/images\/themes\/theme1\/bg.png","profile_background_image_url_https":"https:\/\/abs.twimg.com\/images\/themes\/theme1\/bg.png","profile_background_tile":false,"profile_link_color":"1DA1F2","profile_sidebar_border_color":"C0DEED","profile_sidebar_fill_color":"DDEEF6","profile_text_color":"333333","profile_use_background_image":true,"profile_image_url":"http:\/\/pbs.twimg.com\/profile_images\/1025547681219977217\/ty06Po-e_normal.jpg","profile_image_url_https":"https:\/\/pbs.twimg.com\/profile_images\/1025547681219977217\/ty06Po-e_normal.jpg","default_profile":true,"default_profile_image":false,"following":null,"follow_request_sent":null,"notifications":null},"geo":null,"coordinates":null,"place":null,"contributors":null,"retweeted_status":{"created_at":"Wed Feb 12 16:23:08 +0000 2020","id":1227629216428175362,"id_str":"1227629216428175362","text":"Cada vez que abrimos un micr\u00f3fono para escuchar a una persona nos exponemos a cualquier reacci\u00f3n humana del entrevi\u2026 https:\/\/t.co\/MusxkYepfn","source":"\u003ca href=\"http:\/\/twitter.com\/download\/iphone\" rel=\"nofollow\"\u003eTwitter for iPhone\u003c\/a\u003e","truncated":true,"in_reply_to_status_id":null,"in_reply_to_status_id_str":null,"in_reply_to_user_id":null,"in_reply_to_user_id_str":null,"in_reply_to_screen_name":null,"user":{"id":124355265,"id_str":"124355265","name":"Claudia Gurisatti","screen_name":"CGurisattiNTN24","location":"Colombia","url":"http:\/\/www.ntn24.com","description":"Periodista colombiana | Directora del Canal Internacional de Noticias @NTN24 | Entrevistas| investigaciones|Reportajes| Dirige el programa @LaNocheNTN24","translator_type":"none","protected":false,"verified":true,"followers_count":625695,"friends_count":965,"listed_count":1492,"favourites_count":590,"statuses_count":22677,"created_at":"Fri Mar 19 03:57:58 +0000 2010","utc_offset":null,"time_zone":null,"geo_enabled":true,"lang":null,"contributors_enabled":false,"is_translator":false,"profile_background_color":"131516","profile_background_image_url":"http:\/\/abs.twimg.com\/images\/themes\/theme14\/bg.gif","profile_background_image_url_https":"https:\/\/abs.twimg.com\/images\/themes\/theme14\/bg.gif","profile_background_tile":true,"profile_link_color":"009999","profile_sidebar_border_color":"EEEEEE","profile_sidebar_fill_color":"EFEFEF","profile_text_color":"333333","profile_use_background_image":true,"profile_image_url":"http:\/\/pbs.twimg.com\/profile_images\/1088416129201119232\/bMXMrvTg_normal.jpg","profile_image_url_https":"https:\/\/pbs.twimg.com\/profile_images\/1088416129201119232\/bMXMrvTg_normal.jpg","profile_banner_url":"https:\/\/pbs.twimg.com\/profile_banners\/124355265\/1536620012","default_profile":false,"default_profile_image":false,"following":null,"follow_request_sent":null,"notifications":null},"geo":null,"coordinates":null,"place":null,"contributors":null,"is_quote_status":false,"extended_tweet":{"full_text":"Cada vez que abrimos un micr\u00f3fono para escuchar a una persona nos exponemos a cualquier reacci\u00f3n humana del entrevistado. Un micr\u00f3fono abierto nos obliga a mantener la compostura para preguntar y reaccionar pero jam\u00e1s nos da licencia para insultar. Periodismo ante todo es RESPETO","display_text_range":[0,280],"entities":{"hashtags":[],"urls":[],"user_mentions":[],"symbols":[]}},"quote_count":311,"reply_count":1165,"retweet_count":4241,"favorite_count":10856,"entities":{"hashtags":[],"urls":[{"url":"https:\/\/t.co\/MusxkYepfn","expanded_url":"https:\/\/twitter.com\/i\/web\/status\/1227629216428175362","display_url":"twitter.com\/i\/web\/status\/1\u2026","indices":[117,140]}],"user_mentions":[],"symbols":[]},"favorited":false,"retweeted":false,"filter_level":"low","lang":"es"},"is_quote_status":false,"quote_count":0,"reply_count":0,"retweet_count":0,"favorite_count":0,"entities":{"hashtags":[],"urls":[],"user_mentions":[{"screen_name":"CGurisattiNTN24","name":"Claudia Gurisatti","id":124355265,"id_str":"124355265","indices":[3,19]}],"symbols":[]},"favorited":false,"retweeted":false,"filter_level":"low","lang":"es","timestamp_ms":"1581560967603"}
{"created_at":"Thu Feb 13 02:29:27 +0000 2020","id":1227781803525758982,"id_str":"1227781803525758982","text":"RT @KyleKulinski: Bernie: I'd like to give you healthcare please.\nPete: the unity of our power is the hope of our voiceless.\nKlobuchar: *th\u2026","source":"\u003ca href=\"http:\/\/twitter.com\/download\/iphone\" rel=\"nofollow\"\u003eTwitter for iPhone\u003c\/a\u003e","truncated":false,"in_reply_to_status_id":null,"in_reply_to_status_id_str":null,"in_reply_to_user_id":null,"in_reply_to_user_id_str":null,"in_reply_to_screen_name":null,"user":{"id":2330723844,"id_str":"2330723844","name":"Dante Johnson","screen_name":"SOLUSdante","location":null,"url":null,"description":"why are you even here?","translator_type":"none","protected":false,"verified":false,"followers_count":171,"friends_count":627,"listed_count":6,"favourites_count":5231,"statuses_count":4799,"created_at":"Thu Feb 06 19:11:09 +0000 2014","utc_offset":null,"time_zone":null,"geo_enabled":false,"lang":null,"contributors_enabled":false,"is_translator":false,"profile_background_color":"C0DEED","profile_background_image_url":"http:\/\/abs.twimg.com\/images\/themes\/theme1\/bg.png","profile_background_image_url_https":"https:\/\/abs.twimg.com\/images\/themes\/theme1\/bg.png","profile_background_tile":false,"profile_link_color":"1DA1F2","profile_sidebar_border_color":"C0DEED","profile_sidebar_fill_color":"DDEEF6","profile_text_color":"333333","profile_use_background_image":true,"profile_image_url":"http:\/\/pbs.twimg.com\/profile_images\/1113091599913943040\/UMuoWD3k_normal.jpg","profile_image_url_https":"https:\/\/pbs.twimg.com\/profile_images\/1113091599913943040\/UMuoWD3k_normal.jpg","profile_banner_url":"https:\/\/pbs.twimg.com\/profile_banners\/2330723844\/1454565786","default_profile":true,"default_profile_image":false,"following":null,"follow_request_sent":null,"notifications":null},"geo":null,"coordinates":null,"place":null,"contributors":null,"retweeted_status":{"created_at":"Wed Feb 12 06:57:24 +0000 2020","id":1227486844595687424,"id_str":"1227486844595687424","text":"Bernie: I'd like to give you healthcare please.\nPete: the unity of our power is the hope of our voiceless.\nKlobucha\u2026 https:\/\/t.co\/334U0qMgM8","source":"\u003ca href=\"https:\/\/mobile.twitter.com\" rel=\"nofollow\"\u003eTwitter Web App\u003c\/a\u003e","truncated":true,"in_reply_to_status_id":null,"in_reply_to_status_id_str":null,"in_reply_to_user_id":null,"in_reply_to_user_id_str":null,"in_reply_to_screen_name":null,"user":{"id":143104075,"id_str":"143104075","name":"Secular Talk","screen_name":"KyleKulinski","location":"New York","url":"http:\/\/youtube.com\/seculartalk","description":"\ud83c\udf39 Host of The Kyle Kulinski Show | Over half a billion YouTube views | Populist Left \ud83c\udf39","translator_type":"none","protected":false,"verified":true,"followers_count":272829,"friends_count":1061,"listed_count":1957,"favourites_count":683,"statuses_count":68455,"created_at":"Wed May 12 16:05:25 +0000 2010","utc_offset":null,"time_zone":null,"geo_enabled":false,"lang":null,"contributors_enabled":false,"is_translator":false,"profile_background_color":"000000","profile_background_image_url":"http:\/\/abs.twimg.com\/images\/themes\/theme1\/bg.png","profile_background_image_url_https":"https:\/\/abs.twimg.com\/images\/themes\/theme1\/bg.png","profile_background_tile":false,"profile_link_color":"1B95E0","profile_sidebar_border_color":"000000","profile_sidebar_fill_color":"000000","profile_text_color":"000000","profile_use_background_image":false,"profile_image_url":"http:\/\/pbs.twimg.com\/profile_images\/1190650004756668416\/zEr42qts_normal.jpg","profile_image_url_https":"https:\/\/pbs.twimg.com\/profile_images\/1190650004756668416\/zEr42qts_normal.jpg","profile_banner_url":"https:\/\/pbs.twimg.com\/profile_banners\/143104075\/1523328595","default_profile":false,"default_profile_image":false,"following":null,"follow_request_sent":null,"notifications":null},"geo":null,"coordinates":null,"place":null,"contributors":null,"is_quote_status":false,"extended_tweet":{"full_text":"Bernie: I'd like to give you healthcare please.\nPete: the unity of our power is the hope of our voiceless.\nKlobuchar: *throws stapler*\nWarren: I'm female.\nBiden: It's great to be here in Toledo (he's not in Toledo).","display_text_range":[0,215],"entities":{"hashtags":[],"urls":[],"user_mentions":[],"symbols":[]}},"quote_count":231,"reply_count":489,"retweet_count":4793,"favorite_count":27373,"entities":{"hashtags":[],"urls":[{"url":"https:\/\/t.co\/334U0qMgM8","expanded_url":"https:\/\/twitter.com\/i\/web\/status\/1227486844595687424","display_url":"twitter.com\/i\/web\/status\/1\u2026","indices":[117,140]}],"user_mentions":[],"symbols":[]},"favorited":false,"retweeted":false,"filter_level":"low","lang":"en"},"is_quote_status":false,"quote_count":0,"reply_count":0,"retweet_count":0,"favorite_count":0,"entities":{"hashtags":[],"urls":[],"user_mentions":[{"screen_name":"KyleKulinski","name":"Secular Talk","id":143104075,"id_str":"143104075","indices":[3,16]}],"symbols":[]},"favorited":false,"retweeted":false,"filter_level":"low","lang":"en","timestamp_ms":"1581560967700"}
{"created_at":"Thu Feb 13 02:29:28 +0000 2020","id":1227781804880351232,"id_str":"1227781804880351232","text":"Yeah I'm one of the leading terminally online Bernie Bros and I have absolutely no idea who these people are\n\nAlso\u2026 https:\/\/t.co\/Z8T3RZVk83","source":"\u003ca href=\"http:\/\/twitter.com\/download\/iphone\" rel=\"nofollow\"\u003eTwitter for iPhone\u003c\/a\u003e","truncated":true,"in_reply_to_status_id":null,"in_reply_to_status_id_str":null,"in_reply_to_user_id":null,"in_reply_to_user_id_str":null,"in_reply_to_screen_name":null,"user":{"id":1184253339464273921,"id_str":"1184253339464273921","name":"no more mr wife guy","screen_name":"TheSocietyDude","location":null,"url":"http:\/\/feetguys4klobuchar.com","description":"Assistant Professor of Wife Studies at UC Irvine","translator_type":"none","protected":false,"verified":false,"followers_count":13975,"friends_count":548,"listed_count":34,"favourites_count":48563,"statuses_count":16920,"created_at":"Tue Oct 15 23:44:12 +0000 2019","utc_offset":null,"time_zone":null,"geo_enabled":false,"lang":null,"contributors_enabled":false,"is_translator":false,"profile_background_color":"F5F8FA","profile_background_image_url":"","profile_background_image_url_https":"","profile_background_tile":false,"profile_link_color":"1DA1F2","profile_sidebar_border_color":"C0DEED","profile_sidebar_fill_color":"DDEEF6","profile_text_color":"333333","profile_use_background_image":true,"profile_image_url":"http:\/\/pbs.twimg.com\/profile_images\/1217835388313595904\/yqm7tSjA_normal.jpg","profile_image_url_https":"https:\/\/pbs.twimg.com\/profile_images\/1217835388313595904\/yqm7tSjA_normal.jpg","profile_banner_url":"https:\/\/pbs.twimg.com\/profile_banners\/1184253339464273921\/1581399686","default_profile":true,"default_profile_image":false,"following":null,"follow_request_sent":null,"notifications":null},"geo":null,"coordinates":null,"place":null,"contributors":null,"quoted_status_id":1227714155618209792,"quoted_status_id_str":"1227714155618209792","quoted_status":{"created_at":"Wed Feb 12 22:00:39 +0000 2020","id":1227714155618209792,"id_str":"1227714155618209792","text":"NEW: @Culinary226 releases a statement criticizing Sanders supporters for having \"viciously attacked the Culinary U\u2026 https:\/\/t.co\/XuxtNj0tL3","display_text_range":[0,140],"source":"\u003ca href=\"https:\/\/about.twitter.com\/products\/tweetdeck\" rel=\"nofollow\"\u003eTweetDeck\u003c\/a\u003e","truncated":true,"in_reply_to_status_id":null,"in_reply_to_status_id_str":null,"in_reply_to_user_id":null,"in_reply_to_user_id_str":null,"in_reply_to_screen_name":null,"user":{"id":324169263,"id_str":"324169263","name":"Megan Messerly","screen_name":"meganmesserly","location":"Las Vegas, NV","url":"https:\/\/thenevadaindependent.com\/author\/megan-messerly","description":"@thenvindy reporter covering 2020, health care + #nvleg | @ucberkeley alum | megan@thenvindy.com | dm for pgp + signal | nothing comes close to the golden coast","translator_type":"none","protected":false,"verified":true,"followers_count":11745,"friends_count":1195,"listed_count":368,"favourites_count":6771,"statuses_count":17352,"created_at":"Sun Jun 26 03:51:38 +0000 2011","utc_offset":null,"time_zone":null,"geo_enabled":true,"lang":null,"contributors_enabled":false,"is_translator":false,"profile_background_color":"1A1B1F","profile_background_image_url":"http:\/\/abs.twimg.com\/images\/themes\/theme9\/bg.gif","profile_background_image_url_https":"https:\/\/abs.twimg.com\/images\/themes\/theme9\/bg.gif","profile_background_tile":false,"profile_link_color":"9897C0","profile_sidebar_border_color":"FFFFFF","profile_sidebar_fill_color":"252429","profile_text_color":"666666","profile_use_background_image":true,"profile_image_url":"http:\/\/pbs.twimg.com\/profile_images\/1218762887079968768\/32vKxZSn_normal.jpg","profile_image_url_https":"https:\/\/pbs.twimg.com\/profile_images\/1218762887079968768\/32vKxZSn_normal.jpg","profile_banner_url":"https:\/\/pbs.twimg.com\/profile_banners\/324169263\/1578337868","default_profile":false,"default_profile_image":false,"following":null,"follow_request_sent":null,"notifications":null},"geo":null,"coordinates":null,"place":null,"contributors":null,"is_quote_status":false,"extended_tweet":{"full_text":"NEW: @Culinary226 releases a statement criticizing Sanders supporters for having \"viciously attacked the Culinary Union ... simply because our union has provided facts on what certain healthcare proposals might do to take away the system of care we have built over 8 decades.\" https:\/\/t.co\/Nh5vM0iXbT","display_text_range":[0,276],"entities":{"hashtags":[],"urls":[],"user_mentions":[{"screen_name":"Culinary226","name":"The Culinary Union","id":463053212,"id_str":"463053212","indices":[5,17]}],"symbols":[],"media":[{"id":1227714122072109063,"id_str":"1227714122072109063","indices":[277,300],"media_url":"http:\/\/pbs.twimg.com\/media\/EQm3fUPWsAc1roo.png","media_url_https":"https:\/\/pbs.twimg.com\/media\/EQm3fUPWsAc1roo.png","url":"https:\/\/t.co\/Nh5vM0iXbT","display_url":"pic.twitter.com\/Nh5vM0iXbT","expanded_url":"https:\/\/twitter.com\/meganmesserly\/status\/1227714155618209792\/photo\/1","type":"photo","sizes":{"large":{"w":820,"h":428,"resize":"fit"},"medium":{"w":820,"h":428,"resize":"fit"},"small":{"w":680,"h":355,"resize":"fit"},"thumb":{"w":150,"h":150,"resize":"crop"}}}]},"extended_entities":{"media":[{"id":1227714122072109063,"id_str":"1227714122072109063","indices":[277,300],"media_url":"http:\/\/pbs.twimg.com\/media\/EQm3fUPWsAc1roo.png","media_url_https":"https:\/\/pbs.twimg.com\/media\/EQm3fUPWsAc1roo.png","url":"https:\/\/t.co\/Nh5vM0iXbT","display_url":"pic.twitter.com\/Nh5vM0iXbT","expanded_url":"https:\/\/twitter.com\/meganmesserly\/status\/1227714155618209792\/photo\/1","type":"photo","sizes":{"large":{"w":820,"h":428,"resize":"fit"},"medium":{"w":820,"h":428,"resize":"fit"},"small":{"w":680,"h":355,"resize":"fit"},"thumb":{"w":150,"h":150,"resize":"crop"}}}]}},"quote_count":359,"reply_count":294,"retweet_count":1045,"favorite_count":2141,"entities":{"hashtags":[],"urls":[{"url":"https:\/\/t.co\/XuxtNj0tL3","expanded_url":"https:\/\/twitter.com\/i\/web\/status\/1227714155618209792","display_url":"twitter.com\/i\/web\/status\/1\u2026","indices":[117,140]}],"user_mentions":[{"screen_name":"Culinary226","name":"The Culinary Union","id":463053212,"id_str":"463053212","indices":[5,17]}],"symbols":[]},"favorited":false,"retweeted":false,"possibly_sensitive":false,"filter_level":"low","lang":"en"},"quoted_status_permalink":{"url":"https:\/\/t.co\/TtkFZIzC6H","expanded":"https:\/\/twitter.com\/meganmesserly\/status\/1227714155618209792","display":"twitter.com\/meganmesserly\/\u2026"},"is_quote_status":true,"extended_tweet":{"full_text":"Yeah I'm one of the leading terminally online Bernie Bros and I have absolutely no idea who these people are\n\nAlso if mild online criticism gets you to rethink your political stance.... Then you never actually believed in that political stance. You're just looking for an excuse","display_text_range":[0,278],"entities":{"hashtags":[],"urls":[],"user_mentions":[],"symbols":[]}},"quote_count":0,"reply_count":0,"retweet_count":0,"favorite_count":0,"entities":{"hashtags":[],"urls":[{"url":"https:\/\/t.co\/Z8T3RZVk83","expanded_url":"https:\/\/twitter.com\/i\/web\/status\/1227781804880351232","display_url":"twitter.com\/i\/web\/status\/1\u2026","indices":[116,139]}],"user_mentions":[],"symbols":[]},"favorited":false,"retweeted":false,"filter_level":"low","lang":"en","timestamp_ms":"1581560968023"}
#+end_src

*** Implementation Using Almaren Framework

In order to test it, you can start spark-shell with the following parameters:
#+begin_src org
spark-shell --packages "com.github.music-of-the-ainur:almaren-framework_2.11:0.2.3-2-4,com.github.music-of-the-ainur:solr-almaren_2.11:0.2.4-2-4" --repositories https://repo.boundlessgeo.com/main/
#+end_src

The implementation:
#+begin_src scala :eval no
import com.github.music.of.the.ainur.almaren.builder.Core.Implicit
import com.github.music.of.the.ainur.almaren.Almaren
import com.github.music.of.the.ainur.almaren.solr.Solr.SolrImplicit

val almaren = Almaren("App Test Twitter")

val twitter = almaren.builder
    .sourceSql("select CAST(value AS STRING) as json_column FROM __STREAMING__")
    .deserializer("json","json_column")
    .dsl("""user.id$user_id:LongType
    	|user.name$user_name:StringType
        |user.time_zone$time_zone:StringType
        |user.friends_count$friends_count:LongType
        |user.followers_count$followers_count:LongType
        |source$source:StringType
        |place.country$country:StringType
        |timestamp_ms$timestamp_ms:LongType
        |text$message:StringType
        |entities.hashtags@hashtags
        |	hashtags.text$hashtag:StringType""".stripMargin)
    .sql("SELECT DISTINCT * FROM __TABLE__")
    .sql("""SELECT sha2(concat_ws("",array(*)),256) as id,*,current_timestamp from __TABLE__""")
    .cache(true)
    .targetJdbc(s"jdbc:postgresql://localhost/almaren","org.postgresql.Driver","twitter_streaming",SaveMode.Append)
    .targetSolr("gettingstarted","localhost:9983",Map("batch_size" -> "1000"))

 
almaren.streaming(twitter,Map("kafka.bootstrap.servers" -> "localhost:9092","subscribe" -> "twitter", "startingOffsets" -> "earliest"))
#+end_src

When you create a /streaming/ in *Almaren Framework* it will create a magic table called /__STREAMING__/, with will deserialize
both Kafka's /key/ and /value/ as as byte arrays, in order to deserialize to string just use [[https://spark.apache.org/docs/latest/api/sql/#cast][CAST]] function.

For full list of options, check the [[https://spark.apache.org/docs/latest/structured-streaming-kafka-integration.html][Documentation]].

The PostgreSQL data:
[[images/pg.png]]

The Solr Data:
[[images/solr.png]]


*** Author
Daniel Mantovani [[daniel.mantovani@modak.com][daniel.mantovani@modak.com]]

*** Sponsor
[[http://modak.com][file:/docs/images/modak_analytics.png]]
